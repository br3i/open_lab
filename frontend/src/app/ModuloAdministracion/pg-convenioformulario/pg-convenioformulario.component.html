<div class="card separador-componentes">
    <p-toolbar>
        <div class="p-toolbar-group-center">
            <p>{{ idTipoDonante === personaNatural ? 'DATOS DEL CONVENIO - PERSONA NATURAL':'DATOS DEL CONVENIO -
                PERSONA JURÍDICA'
                }}</p>
        </div>
    </p-toolbar>


    <form [formGroup]="convenioForm">
        <!-- Datos generale sdel convenio -->
        <div class="flex flex-column gap-2 mt-3">
            <label for="resolucion">Resolución:</label>
            <input id="resolucion" pInputText formControlName="resolucion">
        </div>
        <br>
        <div class="form-row">

            <div class="form-field  flex flex-column gap-2 mt-3">
                <label for="titulo">Título del Convenio:</label>
                <textarea id="titulo" pInputText formControlName="titulo" rows="4"></textarea>
            </div>

            <div class="form-field ">
                <label for="objetivo">Objetivo:</label>
                <textarea id="objetivo" pInputText formControlName="objetivo" rows="4"></textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-field">
                <div class="form-row mt-3 align-items-center">
                    <div class="col-auto">
                        <label for="tipoConvenio" class="form-label">Tipo Convenio:</label>
                    </div>
                    <div class="col">
                        <select formControlName="strTipoConvenio"
                            class="select-sm w-full text-base text-color surface-overlay p-2 border-1 border-solid surface-border border-round outline-none focus:border-primary"
                            style="appearance: auto">
                            <option *ngFor="let tipoconvenio of ListadoTipoConvenio"
                                [ngValue]="tipoconvenio.idtipoconvenio">
                                {{tipoconvenio.tipoconvenio_strnombre}}</option>
                        </select>
                    </div>
                </div>

                <div class="form-field">
                    <!-- Lista para seleccionar al coordinador -->
                    <div class="form-row mt-3 align-items-center">
                        <div class="col-auto">
                            <label for="coordinadoresBar" class="form-label">Seleccionar coordinador del FUNDACIÓN FAVORITA:</label>
                        </div>
                        <div class="col">
                            <p-autoComplete formControlName="coordinadorSeleccionadoBar" [dropdown]="true"
                                [showClear]="true" [suggestions]="coordinadoresFiltradosBar"
                                (completeMethod)="filtrarCoordinadoresBar($event)"
                                (onSelect)="onCoordinadorSeleccionado($event)" [field]="'nombreCompleto'"
                                placeholder="Nombre o Apellido">
                            </p-autoComplete>
                        </div>
                    </div>
                    <!-- Primera fila: Nombres y Apellidos -->
                    <div class="form-row mt-3">
                        <div class="col">
                            <label class="form-label" for="nombres">Nombres:</label>
                            <input type="text" id="nombres"
                                [value]="convenioForm.get('coordinadorSeleccionadoBar')?.value?.nombres || ''"
                                class="p-inputtext" disabled placeholder="Nombres">
                        </div>
                        <div class="col">
                            <label for="apellidos">Apellidos:</label>
                            <input type="text" id="apellidos"
                                [value]="convenioForm.get('coordinadorSeleccionadoBar')?.value?.apellidos || ''"
                                class="p-inputtext" disabled placeholder="Apellidos">
                        </div>

                        <div class="col">
                            <label for="cedula">Cédula:</label>
                            <input type="text" id="cedula"
                                [value]="convenioForm.get('coordinadorSeleccionadoBar')?.value?.cedula || ''"
                                class="p-inputtext" disabled placeholder="Cédula">
                        </div>
                        <div class="col">
                            <label for="celular">Celular:</label>
                            <input id="celular" type="text" maxlength="10"
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                [value]="convenioForm.get('coordinadorSeleccionadoBar')?.value?.celular || ''"
                                class="p-inputtext" disabled placeholder="Celular">
                        </div>
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="col">
                        <label for="fechaInicio">Fecha de Inicio: </label>
                        <p-calendar id="fechaInicio" formControlName="fechaInicio" [showIcon]="true" 
                            dateFormat="dd/mm/yy" (onSelect)="calcularFechaFin()">
                        </p-calendar>
                    </div>

                    <div class="col">
                        <label for="anos">Años: </label>
                        <input id="anos" type="number" pInputText formControlName="anos" (input)="calcularFechaFin()">
                    </div>

                    <div class="col">
                        <label for="meses">Meses: </label>
                        <input id="meses" type="number" pInputText formControlName="meses" (input)="calcularFechaFin()">
                    </div>

                    <div class="col">
                        <label for="fechaFin">Fecha de Fin: </label>
                        <p-calendar id="fechaFin" formControlName="fechaFin" [readonlyInput]="true"
                            dateFormat="dd/mm/yy" [showIcon]="true"></p-calendar>
                    </div>
                </div>
            </div>
        </div>

        <p-toolbar>
            <div class="p-toolbar-group-center">
                <p>INFORMACIÓN DEL DONANTE</p>
            </div>
        </p-toolbar>

        <div class="form-row">
            <!-- Seleccionar Empresa-->
            <div class="form-field" >
                <div class="form-row mt-3 align-items-center">
                    <div class="col-auto">
                        <label for="empresa" class="form-label">Seleccionar Empresa:</label>
                    </div>
                    <div class="col">
                        <p-button styleClass="custom-green-button-guardar" label="Listado de Fundaciones" icon="pi pi-briefcase"
                            (click)="ModalListadoDonante()">
                        </p-button>
                    </div>
                </div>

                <p-dialog header="Lista de Fundaciones" [resizable]="false" [modal]="true" [maximizable]="true"
                    appendTo="body" [(visible)]="dialogDonanteVisible" [style]="{width: '50vw'}"
                    [contentStyle]="{height: '300px'}">
                    <div class="flex justify-content-end align-items-center mb-4">
                        <div class="p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input type="text" pInputText placeholder="Búsqueda global"
                                (input)="filtrarEmpresas($event)" />
                        </div>
                    </div>

                    <p-table [value]="listadoEmpresaFiltrado" [(selection)]="empresaSeleccionada" dataKey="ouidempresa"
                        [scrollable]="true" [tableStyle]="{'min-width': '50rem'}">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 4rem"></th>
                                <th>FUNDACIÓN</th>
                                <th>RUC</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-empresa>
                            <tr [pSelectableRow]="empresa">
                                <td><p-tableRadioButton [value]="empresa"></p-tableRadioButton></td>
                                <td>{{ empresa.ouempresa_strnombre }}</td>
                                <td>{{ empresa.oustrruc }}</td>
                            </tr>
                        </ng-template>
                    </p-table>

                    <ng-template pTemplate="footer">
                        <div class="footer-buttons">
                            <br>
                            <p-button icon="pi pi-save" (click)="confirmarEmpresa()" label="Guardar Empresa"
                                styleClass="custom-green-button-guardar"></p-button>

                            <p-button label="Cancelar" icon="pi pi-times" title="Cancelar"
                                styleClass="custom-button-cancelar " type="button"
                                (click)="cerrarModal('ModalDonante')"></p-button>
                        </div>
                    </ng-template>

                </p-dialog>

                <div class="form-row mt-3" *ngIf="empresaSeleccionada">
                    <div class="col">
                        <label class="form-label" for="nombres">Razón Social:</label>
                        <input type="text" id="nombres" [value]="empresaSeleccionada.ouempresa_strnombre" disabled
                            class="p-inputtext" placeholder="Nombres">
                    </div>
                    <div class="col">
                        <label class="form-label" for="ruc">RUC:</label>
                        <input type="text" id="ruc" [value]="empresaSeleccionada.oustrruc" disabled class="p-inputtext"
                            placeholder="ruc">
                    </div>

                    <div class="col">
                        <label class="form-label" for="correo">Correo Electrónico:</label>
                        <input type="text" id="correo" [value]="empresaSeleccionada.ouempresa_strcorreo1" disabled
                            class="p-inputtext" placeholder="Correo">
                    </div>
                    <div class="col">
                        <label class="form-label" for="celular">Celular:</label>
                        <input id="celular" type="text" maxlength="10"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                            [value]="empresaSeleccionada.ouempresa_strcelular1" disabled class="p-inputtext"
                            placeholder="Celular">
                    </div>
                </div>

                <div class="form-field">
                    <!-- Lista para seleccionar al coordinador -->
                    <div class="form-row mt-3 align-items-center">
                        <div class="col-auto">
                            <label for="coordinadores" class="form-label">Seleccionar coordinador:</label>
                        </div>
                        <div class="col">
                            <p-autoComplete formControlName="coordinadorSeleccionadoDonante" [dropdown]="true"
                                [showClear]="true" [suggestions]="coordinadoresFiltradosDonante"
                                (completeMethod)="filtrarCoordinadorDonante($event)"
                                (onSelect)="onCoordinadorSeleccionadoDonante($event)" [field]="'nombresCompleto'"
                                placeholder="Nombre o Apellido">
                            </p-autoComplete>
                        </div>
                    </div>
                    <!-- Primera fila: Nombres y Apellidos -->
                    <div class="form-row mt-3">
                        <div class="col">
                            <label class="form-label" for="nombres">Nombres:</label>
                            <input type="text" id="nombres1"
                                [value]="convenioForm.get('coordinadorSeleccionadoDonante')?.value?.nombres1 || ''"
                                class="p-inputtext" disabled placeholder="Nombres">
                        </div>
                        <div class="col">
                            <label for="apellidos">Apellidos:</label>
                            <input type="text" id="apellidos1"
                                [value]="convenioForm.get('coordinadorSeleccionadoDonante')?.value?.apellidos1 || ''"
                                class="p-inputtext" disabled placeholder="Apellidos">
                        </div>

                        <div class="col">
                            <label for="cedula">Cédula:</label>
                            <input type="text" id="cedula1"
                                [value]="convenioForm.get('coordinadorSeleccionadoDonante')?.value?.cedula1 || ''"
                                class="p-inputtext" disabled placeholder="Cédula">
                        </div>
                        <div class="col">
                            <label for="celular">Celular:</label>
                            <input id="celular1" type="text" maxlength="10"
                                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                [value]="convenioForm.get('coordinadorSeleccionadoDonante')?.value?.celular1 || ''"
                                class="p-inputtext" disabled placeholder="Celular">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seleccionar Persona -->
            <div class="form-field" *ngIf="idTipoDonante === personaNatural">
                <div class="form-row mt-3 align-items-center">
                    <div class="col-auto">
                        <label for="coordinadoresBar" class="form-label">Seleccionar Persona:</label>
                    </div>
                    <div class="col">
                        <p-button styleClass="custom-green-button-guardar" label="Listado de Personas" icon="pi pi-user"
                            (click)="ModalListadoDonante()">
                        </p-button>
                    </div>
                </div>

                <p-dialog header="Lista de Personas" [resizable]="false" [modal]="true" [maximizable]="true"
                    appendTo="body" [(visible)]="dialogDonanteVisible" [style]="{width: '50rem'}"
                    [contentStyle]="{height: '300px'}">
                    <div class="flex justify-content-end align-items-center mb-4">
                        <div class="p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input type="text" pInputText placeholder="Búsqueda global"
                                (input)="filtrarPersona($event)" />
                        </div>
                    </div>

                    <p-table [value]="lsDonantePersonaFiltrado" [(selection)]="personaSeleccionada"
                        dataKey="ouidpersona" [scrollable]="true" [tableStyle]="{'min-width': '50rem'}">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 4rem"></th>
                                <th>PERSONA</th>
                                <th>CÉDULA</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-persona>
                            <tr [pSelectableRow]="persona">
                                <td><p-tableRadioButton [value]="persona"></p-tableRadioButton></td>
                                <td>{{ persona.ounombres +" " + persona.ouapellidos}}</td>
                                <td>{{ persona.oustrcedula }}</td>
                            </tr>
                        </ng-template>
                    </p-table>

                    <ng-template pTemplate="footer">
                        <div class="footer-buttons">
                            <br>
                            <p-button icon="pi pi-save" (click)="confirmarPersona()" label="Guardar Contrato"
                                styleClass="custom-green-button-guardar"></p-button>

                            <p-button label="Cancelar" icon="pi pi-times" title="Cancelar"
                                styleClass="custom-button-cancelar " type="button"
                                (click)="cerrarModal('ModalDonante')"></p-button>
                        </div>
                    </ng-template>


                </p-dialog>

                <div class="form-row mt-3" *ngIf="personaSeleccionada">
                    <div class="col">
                        <label class="form-label" for="nombres">Nombres:</label>
                        <input type="text" id="nombres" [value]="personaSeleccionada.ounombres" disabled
                            class="p-inputtext" placeholder="Nombre">
                    </div>
                    <div class="col">
                        <label class="form-label" for="cedula">Apellidos:</label>
                        <input type="text" id="cedula" [value]="personaSeleccionada.ouapellidos" disabled
                            class="p-inputtext" placeholder="Cédula">
                    </div>
                    <div class="col">
                        <label class="form-label" for="cedula">Cédula:</label>
                        <input type="text" id="cedula" [value]="personaSeleccionada.oustrcedula" disabled
                            class="p-inputtext" placeholder="Cédula">
                    </div>
                    <div class="col">
                        <label class="form-label" for="cedula">Celular:</label>
                        <input id="celular" type="text" [value]="personaSeleccionada.oucelular1" disabled
                            class="p-inputtext" placeholder="Cédula">
                    </div>
                </div>
            </div>
        </div>

        <p-toolbar>
            <div class="p-toolbar-group-center">
                <p>DOCUMENTOS</p>
            </div>
        </p-toolbar>


        <div class="form-field" *ngIf="idTipoDonante === this.personaJuridica">
            <div class="form-row mt-3 align-items-center">
                <div class="col-auto">
                    <label for="contrato" class="form-label">Añadir Contrato:</label>
                </div>
                <div class="col">
                    <p-button styleClass="custom-green-button-guardar" label="Listado de Contratos" icon="pi pi-file"
                        (click)="ModalDialogContratos()">
                    </p-button>
                </div>
            </div>

            <p-dialog header="Lista de Contratos" [resizable]="false" [modal]="true" [maximizable]="true"
                appendTo="body" [(visible)]="dialogContratosVisible" [style]="{width: '75vw'}"
                [contentStyle]="{height: '300px'}">
                <div class="flex justify-content-end align-items-center mb-4">
                    <div class="p-input-icon-left">
                        <i class="pi pi-search"></i>
                        <input type="text" pInputText placeholder="Búsqueda global"
                            (input)="filtrarContratos($event)" />
                    </div>
                </div>

                <p-table [value]="listadoContratoFiltrado" [(selection)]="selectedContrato" dataKey="idcontrato"
                    [scrollable]="true" scrollHeight="flex" [tableStyle]="{'min-width': '50rem'}">
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 4rem"></th>
                            <th>IDENTIFICADOR</th>
                            <th>TÍTULO</th>
                            <th>DESCRIPCIÓN</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-contrato>
                        <tr [pSelectableRow]="contrato">
                            <td><p-tableRadioButton [value]="contrato"></p-tableRadioButton></td>
                            <td>{{ contrato.contrato_stridentificador }}</td>
                            <td>{{ contrato.contrato_strtitulo }}</td>
                            <td>{{ contrato.contrato_strdescripcion }}</td>
                        </tr>
                    </ng-template>
                </p-table>

                <ng-template pTemplate="footer">
                    <div class="footer-buttons">
                        <br>
                        <p-button icon="pi pi-save" (click)="confirmarContrato()" label="Guardar Contrato"
                            styleClass="custom-green-button-guardar"></p-button>

                        <p-button label="Cancelar" icon="pi pi-times" title="Cancelar"
                            styleClass="custom-button-cancelar " type="button"
                            (click)="cerrarModal('ModalContratos')"></p-button>
                    </div>
                </ng-template>
            </p-dialog>

            <div class="form-row mt-3" *ngIf="selectedContrato">
                <div class="col">
                    <label class="form-label" for="nombres">Contrato Selecionado:</label>
                    <input type="text" id="nombres" [value]="selectedContrato.contrato_stridentificador" disabled
                        class="p-inputtext" placeholder="Nombres">
                </div>
            </div>
        </div>



        <div class="centered-content">
            <span class="centered-text">Documentos del Convenio</span>
            <p-button styleClass="custom-green-button-guardar" icon="pi pi-plus" (click)="mostrarModalAgregarDocumento()"
                label="Añadir Documento"></p-button>
        </div>

        <!-- Modal para subir documento -->

        <p-dialog header="Subir documento" [(visible)]="mostrarModal" [modal]="true" [closable]="true"
            [style]="{ width: '600px' }" class="general-modal">

            <ng-template pTemplate="content">
                <div class="modal-header">
                    <p class="modal-subtitle">Proporcione los detalles del documento</p>
                </div>

                <form [formGroup]="formGroup" class="form-container">
                    <!-- Nombre del Documento -->
                    <div class="field-row">
                        <div class="field">
                            <label for="nombreDocumento" class="field-label">Nombre del Documento</label>
                            <div class="p-inputgroup">
                                <span class="p-inputgroup-addon">
                                    <i class="pi pi-tag"></i>
                                </span>
                                <input id="nombreDocumento" formControlName="nombreDocumento" maxlength="100"
                                    placeholder="Ejemplo: Oficio de respaldo"
                                    class="p-inputtext p-component input-text" />
                            </div>
                        </div>

                        <div class="field">
                            <label for="descripcionDocumento" class="field-label">Descripción (opcional)</label>
                            <div class="p-inputgroup">
                                <span class="p-inputgroup-addon">
                                    <i class="pi pi-align-left"></i>
                                </span>
                                <textarea maxlength="150" id="descripcionDocumento"
                                    formControlName="descripcionDocumento" placeholder="Añada una descripción breve"
                                    class="p-inputtext p-component input-text" rows="3"></textarea>
                            </div>
                        </div>


                        <!-- Subir Archivo -->

                        <div class="field">
                            <label for="archivo" class="field-label">Subir Archivo</label>
                            <div class="upload-container" (click)="activarSelector()" (drop)="manejarArchivo($event)"
                                (dragover)="permitirDrop($event)"
                                [class.upload-success]="this.archivoSeleccionado?.name">
                                <input id="archivo" type="file" accept="application/pdf" class="input-file-hidden"
                                    (change)="seleccionarArchivo($event)" />
                                <p class="upload-text" *ngIf="!this.archivoSeleccionado?.name">
                                    <i class="pi pi-upload"></i> Arrastre y suelte un archivo aquí o haga clic para
                                    subir
                                </p>
                                <p class="upload-success-text" *ngIf="this.archivoSeleccionado?.name">
                                    <i class="pi pi-file-pdf"></i> {{ this.archivoSeleccionado?.name }}
                                </p>
                            </div>
                        </div>

                    </div>
                </form>
            </ng-template>
            <!-- Botones -->
            <ng-template pTemplate="footer">
                <div class="footer-buttons">
                    <br>
                    <p-button icon="pi pi-save" (click)="agregarDocumento()" label="Guardar"
                        styleClass="custom-green-button-guardar"></p-button>

                    <p-button label="Cancelar" icon="pi pi-times" title="Cancelar" styleClass="custom-button-cancelar "
                        type="button" (click)="cerrarModal('ModalDocumento')"></p-button>
                </div>
            </ng-template>

        </p-dialog>


        <p-table *ngIf="documentos.length > 0" [value]="documentos" [paginator]="true" [rows]="5" class="mt-3">
            <ng-template pTemplate="header">
                <tr>
                    <th>Número de Documento</th>
                    <th>Nombre del Documento</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-documento let-i="rowIndex">
                <tr>
                    <td>{{ i + 1 }}</td>
                    <td>{{ documento.conv_anexo_strconvenioanexo }}</td>
                    <td>{{ documento.conv_anexo_strdescripcionanexo }}</td>
                    <td>
                        <button type="button" pButton icon="pi pi-eye" (click)="visualizarDocumento(documento)"
                            class="p-button-info"></button>
                        <button type="button" pButton icon="pi pi-power-off" (click)="eliminarDocumento(i)"
                            class="p-button-danger"></button>
                    </td>
                </tr>
            </ng-template>
        </p-table>

        <div class="flex flex-column gap-2 mt-3">
            <label for="observaciones">Observaciones:</label>
            <textarea id="observaciones" pInputText formControlName="observaciones" rows="5" cols="30">
            </textarea>
        </div>
<br> <br>
        <div class="grid">
            <div class="col-8">
                <div class="text-center p-3 border-round-sm font-bold"></div>
            </div>
            <div class="col-4">
                <p-button type="button" icon="pi pi-save" title="Registrar Empresa" label="Registrar"
                    styleClass="custom-green-button-guardar" (click)="registrarConvenio()"></p-button>
            </div>
        </div>

    </form>

    <p-confirmDialog></p-confirmDialog>
    <p-toast></p-toast>
</div>