<!-- p-toast y barra de búsqueda se mantienen igual -->
<p-toast></p-toast>

<p-card header="Dashboard Natural" subheader="Interactúa con tus datos usando lenguaje cotidiano">
    <!-- BARRA DE BÚSQUEDA (sin cambios) -->
    <div class="p-fluid p-formgrid grid mb-4">
        <div class="field col-12 md:col-10">
            <span class="p-input-icon-left w-full">
                <i class="pi pi-search"></i>
                <input
                    type="text"
                    pInputText
                    [(ngModel)]="preguntaUsuario"
                    (keyup.enter)="realizarConsulta()"
                    placeholder="Prueba con: comparar indicadores de nutrición entre 2024 y 2025"
                    class="w-full"
                />
            </span>
        </div>
        <div class="field col-12 md:col-2">
            <button
                pButton
                type="button"
                label="{{ isLoading ? 'Procesando...' : 'Consultar' }}"
                icon="{{ isLoading ? 'pi pi-spin pi-spinner' : 'pi pi-arrow-right' }}"
                (click)="realizarConsulta()"
                [disabled]="isLoading || !preguntaUsuario"
                class="w-full"
            ></button>
        </div>
    </div>

    <!-- ===== SECCIÓN DE RESULTADOS CORREGIDA Y MEJORADA ===== -->
    <div *ngIf="resultado" class="mt-5">
        <p-divider></p-divider>
        <h3 class="text-xl font-semibold text-gray-700 mb-3">{{ resultado.title }}</h3>

        <!-- Mensaje "No hay datos" (mejorado para funcionar con gráficos vacíos) -->
        <div *ngIf="(!resultado.data || (resultado.type !== 'chart' && resultado.data.length === 0))" class="text-center p-4 border-round bg-yellow-100 text-yellow-800">
            <i class="pi pi-info-circle mr-2"></i>
            <span>No se encontraron datos para tu consulta o no fue reconocida.</span>
        </div>

        <!-- Contenedor para el Gráfico de PrimeNG (Ahora con tipo dinámico) -->
        <div *ngIf="resultado.type === 'bar' || resultado.type === 'pie'" class="chart-container">
            <p-chart [type]="chartType" [data]="chartData" [options]="chartOptions" height="400px"></p-chart>
        </div>

        <!-- Tabla dinámica (Con la celda corregida) -->
        <p-table
            *ngIf="resultado.type === 'table' && resultado.data && resultado.data.length > 0"
            [value]="resultado.data"
            [responsive]="true"
            styleClass="p-datatable-striped"
        >
            <ng-template pTemplate="header">
                <tr>
                    <th *ngFor="let key of getObjectKeys(resultado.data[0])">{{ key | titlecase }}</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                      <td *ngFor="let key of getObjectKeys(item)">{{ formatTableCell(item[key], key) }}</td>

                </tr>
            </ng-template>
        </p-table>
    </div>
</p-card>

